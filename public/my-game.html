<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>芝刈りゲーム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <style>
        /* p5.jsが作るボタンのデザインを調整 */
        .restart-button {
            font-size: 20px;
            padding: 10px 20px;
            cursor: pointer;
            position: absolute;
            top: 50%; /* 画面の上下中央 */
            left: 50%; /* 画面の左右中央 */
            transform: translate(-50%, -50%); /* 中央揃えの決まり文句 */
            z-index: 100; /* キャンバスより手前に表示 */
            background-color: #ee930b; /* 緑色 */
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
    </head>

<body>
    <h1>稲刈りゲーム</h1>
    <div id="timer-container" style="font-size: 24px; color: white; background-color: rgba(0, 0, 0, 0.5); padding: 10px; position: absolute; top: 10px; right: 10px; font-family: sans-serif;">
        経過時間: <span id="time">0.0</span> 秒
    </div>
    <div>
        <div>あなたのID: <span id="myid"></span></div>
        <button id="connect">稲刈りスタート</button>
    </div>
    <script>
        // --- サーバー接続とセンサー受信 ---
        let socket = io.connect();
        let btn = document.querySelector("#connect");
        let b = 0; // スマホの傾き（前後）
        let g = 0; // スマホの傾き（左右）
        let myid = sessionStorage.getItem('clientId');
        if (!myid) {
            myid = Math.random().toString(36).substring(2, 15);
            sessionStorage.setItem('clientId', myid);
        }
        document.querySelector("#myid").innerHTML = myid;
        console.log("あなたのID: ", myid);

        btn.addEventListener("click", function () {
            socket.emit("join", "game");
            btn.remove();
            isTimerStarted = true;
            startTime = millis();
        });
        
        socket.on("sensor", function (data) {
            g = parseFloat(data.g);
            b = parseFloat(data.b);
        });

        // プレイヤー
        let x = 0;
        let y = 0;
        let speed = 0.1;

        // 草
        let grassStatus = [];
        let grassCount = 100;
        let rotY = 0;
        let w = 2;
        let h = 30;
        let d = 5;

        // ゲーム状態
        let isGameClear = false;
        let isTimerStarted = false; 

        // 時間管理
        let startTime = 0;
        let elapsedTime = 0;
        
        // 障害物リスト
        let obstacles = [
            { x: 100, y: 100, w: 60, h: 60, d: 60 },
            { x: -150, y: -50, w: 100, h: 40, d: 60 },
            { x: 200, y: -150, w: 40, h: 150, d: 60 }
        ];

        let restartButton;


        function setup() {
            createCanvas(800, 800, WEBGL);
            camera(0, 600, 600, 0, 0, 0, 0, 1, 0); 
            noStroke();

            // リスタートボタン
            restartButton = createButton('もう一度プレイ');
            restartButton.addClass('restart-button'); 
            restartButton.hide(); 
            restartButton.mousePressed(restartGame); 
            initializeGame();
        }


        function initializeGame() {
            // プレイヤー位置をリセット
            x = 0;
            y = 0;
            
            // ゲーム状態をリセット
            isGameClear = false;
            isTimerStarted = false; 
            
            // タイマー表示をリセット
            elapsedTime = 0;
            let timerContainer = document.getElementById("timer-container");
            if (timerContainer) {
                 // "CLEAR!" の表示を元に戻す
                timerContainer.innerHTML = '経過時間: <span id="time">0.0</span> 秒';
            }
            
            // 草の状態をリセット
            grassStatus = []; 
            grassCount = 0;   
            let nearDistance = 80; 
            for (let j = 0; j < 10; j++) {
                for (let i = 0; i < 10; i++) {
                    let grassX = -200 + 40 * i;
                    let grassY = -200 + 40 * j;
                    let isNear = false; 
                    let isOverlapping = false; 
                    for (let obs of obstacles) {
                        let obsHalfW = obs.w / 2;
                        let obsHalfH = obs.h / 2;
                        if (grassX > obs.x - obsHalfW &&
                            grassX < obs.x + obsHalfW &&
                            grassY > obs.y - obsHalfH &&
                            grassY < obs.y + obsHalfH) {
                            isOverlapping = true;
                        }
                        let distanceToObs = dist(grassX, grassY, obs.x, obs.y);
                        let obsRadius = (obs.w + obs.h) / 4; 
                        if (distanceToObs < obsRadius + nearDistance) {
                           isNear = true;
                        }
                    }
                    if (isNear && !isOverlapping) {
                        grassStatus.push(true);
                        grassCount++; 
                    } else {
                        grassStatus.push(false); 
                    }
                }
            }
            console.log("初期化完了。草の数: ", grassCount);
        }

        
        function restartGame() {
            console.log("リスタートします...");
            // ボタンを隠す
            restartButton.hide();
            
            // ゲーム状態をリセット
            initializeGame();
            
            // タイマーを開始
            isTimerStarted = true;
            startTime = millis();
            
            // p5.jsの描画ループを再開
            loop();
        }
        

        function draw() {
            // ゲームクリアしたら画面を止める
            if (isGameClear) {
                return;
            }

            // --- 経過時間の計算と表示 ---
            if (isTimerStarted) {
                elapsedTime = (millis() - startTime) / 1000;
                let timeSpan = document.getElementById("time");
                if (timeSpan) {
                    timeSpan.innerText = elapsedTime.toFixed(1);
                }
            }

            // --- 描画処理 ---
            background(0);
            orbitControl();
            ambientLight(50, 50, 50);
            directionalLight(100, 20, 20, -1, -1, -1);
            pointLight(20, 20, 100, 0, 0, 800);

            push(); 
            rotateX((-PI * b) / 180);
            rotateY((PI * g) / 180);
            translate(0, 0, -50); 

            // 板
            push();
            fill(100, 70, 20);
            box(800, 800, 30);
            pop();

            // 障害物
            fill(100, 100, 100); 
            for (let obs of obstacles) {
                push();
                translate(obs.x, obs.y, obs.d / 2); 
                box(obs.w, obs.h, obs.d);
                pop();
            }

            // プレイヤー
            let prevX = x;
            let prevY = y;
            x = x + speed * g;
            y = y + speed * b;
            if (x > 400) x = 400;
            if (y > 400) y = 400;
            if (x < -400) x = -400;
            if (y < -400) y = -400;

            // 当たり判定
            let playerSize = 40; 
            let playerHalf = playerSize / 2;
            let isCollided = false;
            for (let obs of obstacles) {
                let obsHalfW = obs.w / 2;
                let obsHalfH = obs.h / 2;
                let colX = (x + playerHalf > obs.x - obsHalfW) &&
                           (x - playerHalf < obs.x + obsHalfW);
                let colY = (y + playerHalf > obs.y - obsHalfH) &&
                           (y - playerHalf < obs.y + obsHalfH);
                if (colX && colY) {
                    isCollided = true;
                    break;
                }
            }
            if (isCollided) {
                x = prevX;
                y = prevY;
            }

            // プレイヤー描画
            push();
            translate(x, y, playerSize / 2); 
            fill(150, 150, 150);
            box(playerSize, playerSize, playerSize); 
            pop();

            // 草の描画と当たり判定
            rotY += (0.01 * PI * g) / 180;
            if (rotY > 0.1) rotY = 0.1;
            if (rotY < -0.1) rotY = -0.1;

            let grassIndex = 0; 
            for (let j = 0; j < 10; j++) {
                for (let i = 0; i < 10; i++) {
                    if (grassStatus[grassIndex] === true) {
                        let grassX = -200 + 40 * i;
                        let grassY = -200 + 40 * j;
                        let distance = dist(x, y, grassX, grassY);
                        if (distance < 30) { 
                            grassStatus[grassIndex] = false; 
                            grassCount--;
                            console.log("刈った！ 残り: ", grassCount);
                        }
                        push();
                        translate(grassX, grassY, 0); 
                        arm();
                        pop();
                    }
                    grassIndex++;
                }
            }
            
            pop(); 

            // クリア判定
            if (grassCount <= 0 && !isGameClear) {
                isGameClear = true; // 状態を「クリア済み」
                console.log("!!! ゲームクリア !!!");
                
                // 最終タイム表示
                let finalTime = elapsedTime.toFixed(1);
                console.log("クリアタイム: " + finalTime + " 秒");
                document.getElementById("timer-container").innerHTML = "CLEAR! " + finalTime + " 秒";
                
                restartButton.show();
                
                // 画面を停止
                noLoop(); 
            }
        }

        // 草
        function arm() {
            for (i = 0; i < 10; i++) {
                rotateY(rotY);
                fill(255, 215, 0);
                box(w, d, h);
                let x = (h / 2) * sin(rotY);
                let z = (h / 2) * cos(rotY);
                translate(x, 0, 2 * z);
            }
        }
    </script>
</body>
</html>